<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>共有ハザードマップ</title>
    <style>
        body {
            margin: 0;
            font-family: sans-serif;
        }
        #map {
            height: 100vh;
            width: 100%;
        }
        .control-panel {
            position: fixed;
            top: 10px;
            right: 10px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            max-width: 300px;
        }
        .layer-controls {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }
        .mode-controls {
            margin-bottom: 10px;
        }
        .control-button {
            padding: 8px 16px;
            margin: 0 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background-color: #f8f9fa;
        }
        .control-button.active {
            background-color: #1976d2;
            color: white;
        }
        .share-controls {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }
        .share-button {
            background-color: #28a745;
            color: white;
            width: 100%;
            margin-top: 5px;
        }
        .message-form {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            width: 300px;
            display: none;
        }
        .form-input {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .form-textarea {
            width: 100%;
            height: 100px;
            margin-bottom: 10px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
        }
        .button-group {
            display: flex;
            gap: 10px;
        }
        .button-group button {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .save-button { background-color: #1976d2; color: white; }
        .delete-button { background-color: #dc3545; color: white; }
        .cancel-button { background-color: #6c757d; color: white; }
        .popup-content {
            max-width: 250px;
        }
        .popup-title {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .popup-message {
            margin-bottom: 5px;
        }
        .popup-meta {
            font-size: 0.8em;
            color: #666;
        }
        .layer-checkbox {
            margin: 5px 0;
            display: block;
        }
        #currentLocationButton {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            padding: 10px;
            background-color: white;
            border: 1px solid #ccc;
            border-radius: 5px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        #currentLocationButton:hover {
            background-color: #f0f0f0;
        }
        .custom-red-marker {
            filter: hue-rotate(300deg) saturate(200%);
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(0.95); }
            50% { transform: scale(1.1); }
            100% { transform: scale(0.95); }
        }
        .delete-menu {
            text-align: center;
            margin-top: 10px;
        }
        .delete-btn {
            background-color: #dc3545;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            border: none;
        }
    </style>
</head>
<body>
    <div class="control-panel">
        <div class="mode-controls">
            <button id="viewMode" class="control-button active">閲覧</button>
            <button id="editMode" class="control-button">編集</button>
        </div>
        <div class="layer-controls">
            <label class="layer-checkbox">
                <input type="checkbox" id="floodLayer"> 洪水ハザードマップ
            </label>
            <label class="layer-checkbox">
                <input type="checkbox" id="landslideLayer"> 土砂災害ハザードマップ
            </label>
            <label class="layer-checkbox">
                <input type="checkbox" id="earthquakeLayer"> 地震ハザードマップ
            </label>
        </div>
        <div class="share-controls">
            <button onclick="shareLocation()" class="control-button share-button">現在の表示位置を共有</button>
        </div>
    </div>

    <div id="map"></div>

    <div id="messageForm" class="message-form">
        <input type="text" id="pinTitle" class="form-input" placeholder="タイトル" maxlength="50">
        <textarea id="pinMessage" class="form-textarea" placeholder="メッセージを入力してください"></textarea>
        <input type="text" id="authorName" class="form-input" placeholder="投稿者名">
        <div class="button-group">
            <button class="save-button" onclick="savePin()">保存</button>
            <button class="delete-button" onclick="deletePin()">削除</button>
            <button class="cancel-button" onclick="cancelEdit()">キャンセル</button>
        </div>
    </div>

    <div id="currentLocationButton" onclick="updateCurrentLocation()">現在地を更新</div>

    <script>
        let map;
        let currentMarker = null;
        let editMode = false;
        let markers = new Map();
        let hazardLayers = {};
        let currentLocationMarker = null;

        // カスタム赤色マーカーアイコン
        const redIcon = L.icon({
            iconUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-icon.png',
            shadowUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41],
            className: 'custom-red-marker'
        });

        async function initializeMap() {
            await loadLeaflet();

            const urlParams = new URLSearchParams(window.location.search);
            const lat = parseFloat(urlParams.get('lat')) || 35.6812;
            const lng = parseFloat(urlParams.get('lng')) || 139.7671;
            const zoom = parseInt(urlParams.get('zoom')) || 13;

            map = L.map('map').setView([lat, lng], zoom);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            initializeHazardLayers();
            setupEventListeners();
            loadMarkers();
            getCurrentLocation();
        }

        function initializeHazardLayers() {
            hazardLayers = {
                flood: L.tileLayer('https://disaportaldata.gsi.go.jp/raster/01_flood_l2_shinsuishin_data/{z}/{x}/{y}.png', {
                    opacity: 0.7
                }),
                landslide: L.tileLayer('https://disaportaldata.gsi.go.jp/raster/05_dosekiryukiken/{z}/{x}/{y}.png', {
                    opacity: 0.7
                }),
                earthquake: L.tileLayer('https://disaportaldata.gsi.go.jp/raster/04_jishindo250m/{z}/{x}/{y}.png', {
                    opacity: 0.7
                })
            };

            document.getElementById('floodLayer').addEventListener('change', (e) =>
                toggleHazardLayer('flood', e.target.checked));
            document.getElementById('landslideLayer').addEventListener('change', (e) =>
                toggleHazardLayer('landslide', e.target.checked));
            document.getElementById('earthquakeLayer').addEventListener('change', (e) =>
                toggleHazardLayer('earthquake', e.target.checked));
        }

        function toggleHazardLayer(layerName, show) {
            if (show) hazardLayers[layerName].addTo(map);
            else hazardLayers[layerName].remove();
        }

        function setupEventListeners() {
            document.getElementById('viewMode').addEventListener('click', () => setMapMode('view'));
            document.getElementById('editMode').addEventListener('click', () => setMapMode('edit'));
            map.on('click', (e) => editMode && createNewPin(e.latlng));
        }

        function shareLocation() {
            const center = map.getCenter();
            const zoom = map.getZoom();
            const shareUrl = `${window.location.origin}${window.location.pathname}?lat=${center.lat}&lng=${center.lng}&zoom=${zoom}`;
            
            navigator.clipboard.writeText(shareUrl).then(() => {
                alert('共有用URLをクリップボードにコピーしました');
            }).catch(err => {
                console.error('URLのコピーに失敗しました:', err);
                alert('共有用URL:\n' + shareUrl);
            });
        }

        function setMapMode(mode) {
            editMode = mode === 'edit';
            document.getElementById('viewMode').classList.toggle('active', !editMode);
            document.getElementById('editMode').classList.toggle('active', editMode);
            document.getElementById('map').style.cursor = editMode ? 'crosshair' : 'grab';
        }

        function createNewPin(latlng) {
            if (currentMarker) map.removeLayer(currentMarker);
            currentMarker = L.marker(latlng, {
                draggable: true,
                icon: redIcon
            }).addTo(map);
            showMessageForm();
        }

        function showMessageForm() {
            document.getElementById('messageForm').style.display = 'block';
            document.getElementById('pinTitle').value = '';
            document.getElementById('pinMessage').value = '';
            document.getElementById('authorName').value = localStorage.getItem('lastAuthorName') || '';
        }

        function savePin() {
            const title = document.getElementById('pinTitle').value.trim();
            const message = document.getElementById('pinMessage').value.trim();
            const author = document.getElementById('authorName').value.trim();

            if (!title || !message || !author) {
                alert('すべての項目を入力してください');
                return;
            }

            localStorage.setItem('lastAuthorName', author);
            const latlng = currentMarker.getLatLng();

            const pinData = {
                id: Date.now(),
                title: title,
                message: message,
                author: author,
                position: latlng,
                timestamp: new Date().toLocaleString()
            };

            const marker = L.marker(latlng, { icon: redIcon }).addTo(map);
            marker.bindPopup(createPopupContent(pinData));
            marker.on('popupopen', () => setupDeleteHandler(pinData.id));
            markers.set(pinData.id, { marker, data: pinData });

            saveMarkers();
            cancelEdit();
        }

        function setupDeleteHandler(id) {
            document.getElementById('deletePinBtn').onclick = () => {
                if (confirm('本当にこのピンを削除しますか？')) {
                    const markerData = markers.get(id);
                    map.removeLayer(markerData.marker);
                    markers.delete(id);
                    saveMarkers();
                }
            };
        }

        function createPopupContent(pinData) {
            return `
                <div class="popup-content">
                    <div class="popup-title">${escapeHtml(pinData.title)}</div>
                    <div class="popup-message">${escapeHtml(pinData.message)}</div>
                    <div class="popup-meta">
                        投稿者: ${escapeHtml(pinData.author)}<br>
                        緯度: ${pinData.position.lat.toFixed(6)}<br>
                        経度: ${pinData.position.lng.toFixed(6)}<br>
                        ${pinData.timestamp}
                    </div>
                    <div class="delete-menu">
                        <button id="deletePinBtn" class="delete-btn">削除</button>
                    </div>
                </div>
            `;
        }

        function deletePin() {
            if (currentMarker) {
                map.removeLayer(currentMarker);
                currentMarker = null;
            }
            cancelEdit();
        }

        function cancelEdit() {
            document.getElementById('messageForm').style.display = 'none';
            if (currentMarker) {
                map.removeLayer(currentMarker);
                currentMarker = null;
            }
        }

        function saveMarkers() {
            const markersData = Array.from(markers.values()).map(({ data }) => data);
            localStorage.setItem('mapMarkers', JSON.stringify(markersData));
        }

        function loadMarkers() {
            const savedMarkers = localStorage.getItem('mapMarkers');
            if (savedMarkers) {
                JSON.parse(savedMarkers).forEach(markerData => {
                    const marker = L.marker(markerData.position, { icon: redIcon }).addTo(map);
                    marker.bindPopup(createPopupContent(markerData));
                    marker.on('popupopen', () => setupDeleteHandler(markerData.id));
                    markers.set(markerData.id, { marker, data: markerData });
                });
            }
        }

        function getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        const latlng = {lat: position.coords.latitude, lng: position.coords.longitude};
                        map.setView(latlng, 15);
                        updateCurrentLocationMarker(latlng);
                    },
                    error => {
                        console.error('位置情報の取得に失敗しました:', error);
                        alert('現在地の取得に失敗しました。');
                    },
                    { enableHighAccuracy: true, timeout: 5000 }
                );
            } else {
                alert('このブラウザでは位置情報が利用できません。');
            }
        }

        function updateCurrentLocation() {
            getCurrentLocation();
        }

        function updateCurrentLocationMarker(latlng) {
            if (currentLocationMarker) {
                currentLocationMarker.setLatLng(latlng);
            } else {
                currentLocationMarker = L.marker(latlng).addTo(map);
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function loadLeaflet() {
            return new Promise((resolve, reject) => {
                const css = document.createElement('link');
                css.rel = 'stylesheet';
                css.href = 'https://unpkg.com/leaflet@1.7.1/dist/leaflet.css';
                document.head.appendChild(css);

                const script = document.createElement('script');
                script.src = 'https://unpkg.com/leaflet@1.7.1/dist/leaflet.js';
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        initializeMap();
    </script>
</body>
</html>
