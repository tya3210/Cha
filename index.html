<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>防災情報マップ - 改良版</title>
    <style>
        html, body, #map {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        .leaflet-popup-content {
            font-size: 14px;
        }
        .message-form {
            margin: 0;
        }
        .message-form textarea {
            width: 100%;
            height: 60px;
            resize: none;
        }
        .message-list {
            max-height: 100px;
            overflow-y: auto;
            margin-top: 10px;
        }
        .message-item {
            border-bottom: 1px solid #ccc;
            padding: 5px 0;
        }
        .message-author {
            font-weight: bold;
            margin-right: 5px;
        }
        .delete-pin {
            color: red;
            cursor: pointer;
            font-size: 12px;
            display: block;
            margin-top: 10px;
        }
        .username-container {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: rgba(255,255,255,0.9);
            padding: 10px;
            border-radius: 5px;
        }
        .username-container input {
            width: 150px;
        }
    </style>
    <!-- LeafletのCSSを読み込み -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
</head>
<body>
    <!-- ユーザー名の設定 -->
    <div class="username-container">
        お名前: <input type="text" id="usernameInput" placeholder="ユーザー名を入力" />
    </div>
    <div id="map"></div>

    <!-- LeafletのJSを読み込み -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <!-- 地理院タイル読み込み -->
    <script src="https://maps.gsi.go.jp/js/leaflet-gsi.js"></script>
    <!-- Leaflet.LocateのCSSとJSを読み込み -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.css" />
    <script src="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.js"></script>
    <!-- サニタイズ用のDOMPurifyを読み込み -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@2.4.0/dist/purify.min.js"></script>
    <script>
        // 言語設定（多言語対応のためにテキストをまとめる）
        const texts = {
            mapTitle: "防災情報マップ",
            placeholderMessage: "伝言を入力してください",
            placeholderUsername: "ユーザー名を入力",
            postButton: "投稿",
            deletePin: "このピンを削除",
            currentLocation: "現在地",
            displayCurrentLocation: "現在地を表示",
            alertLocationError: "位置情報を取得できませんでした。",
            alertNoUsername: "ユーザー名を入力してください。",
            nameLabel: "お名前: "
        };

        document.title = texts.mapTitle;

        // ユーザー名の管理
        var username = localStorage.getItem('username') || '';
        var usernameInput = document.getElementById('usernameInput');
        usernameInput.value = username;
        usernameInput.placeholder = texts.placeholderUsername;

        usernameInput.addEventListener('change', function() {
            username = usernameInput.value.trim();
            localStorage.setItem('username', username);
        });

        // 地図の初期化
        var map = L.map('map', {
            center: [35.681236, 139.767125], // 東京駅の位置
            zoom: 13
        });

        // 地理院地図の標準タイルを追加
        var stdMap = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png', {
            attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html'>地理院タイル</a>"
        }).addTo(map);

        // ハザードマップのレイヤー追加（浸水想定区域）
        var floodLayer = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/inundation/{z}/{x}/{y}.png', {
            opacity: 0.5
        });

        // レイヤーコントロールを追加
        var baseMaps = {
            "標準地図": stdMap
        };

        var overlayMaps = {
            "浸水想定区域": floodLayer
        };

        L.control.layers(baseMaps, overlayMaps).addTo(map);

        // ピンのアイコン設定
        var emptyPinIcon = L.icon({
            iconUrl: 'https://maps.gsi.go.jp/image/marker_purple.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34]
        });

        var messagePinIcon = L.icon({
            iconUrl: 'https://maps.gsi.go.jp/image/marker_red.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34]
        });

        // ピンを管理する配列
        var pins = [];

        // 一時的な空のピンを保持する変数
        var currentEmptyPin = null;

        // localStorageからピンのデータを読み込み
        loadPinsFromStorage();

        // マップをクリックしたときの処理
        map.on('click', function(e) {
            // ユーザー名が未入力の場合はアラートを表示
            if (!username.trim()) {
                alert(texts.alertNoUsername);
                return;
            }

            // 既存の空のピンがあり、メッセージがない場合は削除
            if (currentEmptyPin && currentEmptyPin.data.messages.length === 0) {
                map.removeLayer(currentEmptyPin);
            }

            // 新しい空のピンを設置
            currentEmptyPin = L.marker(e.latlng, { icon: emptyPinIcon }).addTo(map);

            // ピンにメッセージを保存するオブジェクトを追加
            currentEmptyPin.data = {
                messages: []
            };

            // ピンにポップアップを設定
            currentEmptyPin.bindPopup(createPopupContent(currentEmptyPin)).openPopup();
        });

        // ポップアップの内容を生成
        function createPopupContent(marker) {
            var container = document.createElement('div');

            // メッセージフォーム
            var form = document.createElement('form');
            form.className = 'message-form';

            var textarea = document.createElement('textarea');
            textarea.placeholder = texts.placeholderMessage;
            form.appendChild(textarea);

            var submitButton = document.createElement('input');
            submitButton.type = 'submit';
            submitButton.value = texts.postButton;
            form.appendChild(submitButton);

            // メッセージリスト
            var messageList = document.createElement('div');
            messageList.className = 'message-list';

            // 既存のメッセージを表示
            marker.data.messages.forEach(function(msgObj) {
                var messageItem = document.createElement('div');
                messageItem.className = 'message-item';

                var authorSpan = document.createElement('span');
                authorSpan.className = 'message-author';
                authorSpan.textContent = sanitize(msgObj.author + ": ");

                var messageSpan = document.createElement('span');
                messageSpan.textContent = sanitize(msgObj.text);

                messageItem.appendChild(authorSpan);
                messageItem.appendChild(messageSpan);
                messageList.appendChild(messageItem);
            });

            // フォーム送信時の処理
            form.onsubmit = function(e) {
                e.preventDefault();
                var msg = textarea.value.trim();
                if (msg) {
                    var msgObj = {
                        author: username,
                        text: msg
                    };
                    marker.data.messages.push(msgObj);

                    var messageItem = document.createElement('div');
                    messageItem.className = 'message-item';

                    var authorSpan = document.createElement('span');
                    authorSpan.className = 'message-author';
                    authorSpan.textContent = sanitize(username + ": ");

                    var messageSpan = document.createElement('span');
                    messageSpan.textContent = sanitize(msg);

                    messageItem.appendChild(authorSpan);
                    messageItem.appendChild(messageSpan);
                    messageList.appendChild(messageItem);

                    textarea.value = '';
                    textarea.focus();

                    // 空のピンから正式なピンに移動
                    if (currentEmptyPin === marker) {
                        // アイコンを変更
                        marker.setIcon(messagePinIcon);
                        pins.push(marker);
                        currentEmptyPin = null;
                    }

                    // ピンのデータを保存
                    savePinsToStorage();
                }
            };

            container.appendChild(form);
            container.appendChild(messageList);

            // ピン削除ボタン
            var deleteLink = document.createElement('a');
            deleteLink.href = '#';
            deleteLink.className = 'delete-pin';
            deleteLink.textContent = texts.deletePin;
            deleteLink.onclick = function(e) {
                e.preventDefault();
                map.removeLayer(marker);
                pins = pins.filter(function(pin) {
                    return pin !== marker;
                });
                // ピンのデータを保存
                savePinsToStorage();
            };
            container.appendChild(deleteLink);

            return container;
        }

        // サニタイズ関数（DOMPurifyを使用）
        function sanitize(str) {
            return DOMPurify.sanitize(str);
        }

        // 現在地を円形マーカーで表示
        function onLocationFound(e) {
            var radius = e.accuracy / 2;

            // 既存の現在地マーカーと精度円を削除
            if (currentLocationMarker) {
                map.removeLayer(currentLocationMarker);
            }
            if (currentLocationCircle) {
                map.removeLayer(currentLocationCircle);
            }

            // 円形マーカーを作成
            currentLocationMarker = L.circleMarker(e.latlng, {
                radius: 10,
                fillColor: '#3388ff',
                color: '#fff',
                weight: 2,
                opacity: 1,
                fillOpacity: 1
            }).addTo(map).bindPopup(texts.currentLocation).openPopup();

            // 精度を示す円
            currentLocationCircle = L.circle(e.latlng, radius, {
                color: '#136AEC',
                fillColor: '#136AEC',
                fillOpacity: 0.15
            }).addTo(map);
        }

        var currentLocationMarker = null;
        var currentLocationCircle = null;

        map.on('locationfound', onLocationFound);

        // 位置情報取得失敗時の処理
        function onLocationError(e) {
            alert(texts.alertLocationError);
        }

        map.on('locationerror', onLocationError);

        // 現在地ボタンを追加
        L.control.locate({
            position: 'topleft',
            drawCircle: false,
            showCompass: true,
            locateOptions: {
                maxZoom: 16,
                watch: true,
                setView: true
            },
            strings: {
                title: texts.displayCurrentLocation
            },
            onLocationError: onLocationError,
            onLocationFound: onLocationFound
        }).addTo(map);

        // ピンのデータをlocalStorageに保存
        function savePinsToStorage() {
            var pinsData = pins.map(function(pin) {
                return {
                    latlng: pin.getLatLng(),
                    messages: pin.data.messages
                };
            });
            localStorage.setItem('pins', JSON.stringify(pinsData));
        }

        // localStorageからピンのデータを読み込み
        function loadPinsFromStorage() {
            var savedPins = localStorage.getItem('pins');
            if (savedPins) {
                var pinsData = JSON.parse(savedPins);
                pinsData.forEach(function(pinData) {
                    var icon = pinData.messages.length > 0 ? messagePinIcon : emptyPinIcon;
                    var pin = L.marker(pinData.latlng, { icon: icon }).addTo(map);
                    pin.data = {
                        messages: pinData.messages
                    };
                    pin.bindPopup(createPopupContent(pin));
                    pins.push(pin);
                });
            }
        }

        // ページ読み込み時にユーザー名が未設定の場合の処理
        if (!username.trim()) {
            setTimeout(function() {
                alert(texts.alertNoUsername);
            }, 500);
        }
    </script>
</body>
</html>
