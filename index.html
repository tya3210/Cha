<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>総合防災支援プラットフォーム</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
        #container { display: grid; grid-template-columns: 300px 1fr; height: 100vh; }
        #sidebar { background: #f0f0f0; padding: 20px; overflow-y: auto; }
        #map { height: 100%; }
        .form-section { background: white; padding: 15px; margin: 10px 0; border-radius: 8px; }
        .leaflet-marker-icon { background: transparent; border: none; }
        .marker-info { max-width: 200px; }
        .log-entry { border-bottom: 1px solid #ccc; padding: 5px 0; }
    </style>
</head>
<body>
    <div id="container">
        <div id="sidebar">
            <div class="form-section">
                <h3>表示レイヤー</h3>
                <label><input type="checkbox" id="layer-shops" checked> 営業再開店舗</label><br>
                <label><input type="checkbox" id="layer-shelters" checked> 避難所情報</label><br>
                <label><input type="checkbox" id="layer-messages" checked> 伝言掲示板</label>
            </div>

            <div class="form-section" id="message-form">
                <h3>伝言を投稿</h3>
                <input type="text" id="message-title" placeholder="タイトル"><br>
                <textarea id="message-content" placeholder="内容"></textarea><br>
                <button onclick="saveMessage()">投稿</button>
            </div>

            <div class="form-section" id="shelter-report">
                <h3>避難所状況報告</h3>
                <select id="shelter-select">
                    <option value="shelter1">避難所A</option>
                    <option value="shelter2">避難所B</option>
                </select>
                <input type="number" id="shelter-people" placeholder="人数">
                <button onclick="reportShelter()">報告</button>
            </div>

            <div class="form-section">
                <h3>防災アクションログ</h3>
                <textarea id="log-content" placeholder="経験した内容"></textarea>
                <button onclick="saveLog()">記録</button>
                <div id="log-history"></div>
            </div>
        </div>

        <div id="map"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        let map;
        let layerControl;
        const layers = {
            shops: L.layerGroup(),
            shelters: L.layerGroup(),
            messages: L.layerGroup()
        };

        function initMap() {
            map = L.map('map').setView([35.681236, 139.767125], 14);

            // 国土地理院の地図タイル
            L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png', {
                attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank'>国土地理院</a>"
            }).addTo(map);

            // レイヤー制御
            layerControl = L.control.layers(null, {
                '営業再開店舗': layers.shops,
                '避難所情報': layers.shelters,
                '伝言掲示板': layers.messages
            }).addTo(map);

            // 初期データ
            loadSampleData();
            setupLayerControls();
            loadFromLocalStorage();
        }

        function setupLayerControls() {
            document.getElementById('layer-shops').addEventListener('change', e => {
                e.target.checked ? map.addLayer(layers.shops) : map.removeLayer(layers.shops);
            });
            document.getElementById('layer-shelters').addEventListener('change', e => {
                e.target.checked ? map.addLayer(layers.shelters) : map.removeLayer(layers.shelters);
            });
            document.getElementById('layer-messages').addEventListener('change', e => {
                e.target.checked ? map.addLayer(layers.messages) : map.removeLayer(layers.messages);
            });
        }

        function addMarker(layer, latlng, title, content) {
            const marker = L.marker(latlng, {
                title: title
            }).addTo(layers[layer]);

            marker.bindPopup(`
                <div class="marker-info">
                    <h4>${title}</h4>
                    <p>${content}</p>
                </div>
            `);
            return marker;
        }

        function saveMessage() {
            navigator.geolocation.getCurrentPosition(position => {
                const title = document.getElementById('message-title').value;
                const content = document.getElementById('message-content').value;
                const latlng = [position.coords.latitude, position.coords.longitude];
                
                addMarker('messages', latlng, title, content);
                saveToLocalStorage('messages', { latlng, title, content });
            });
        }

        function reportShelter() {
            const shelter = document.getElementById('shelter-select').value;
            const people = document.getElementById('shelter-people').value;
            console.log(`避難所: ${shelter}, 人数: ${people}`);
        }

        function saveLog() {
            const content = document.getElementById('log-content').value;
            const logEntry = {
                date: new Date().toLocaleString(),
                content: content,
                advice: generateAdvice(content)
            };
            
            saveToLocalStorage('logs', logEntry);
            displayLogs();
        }

        function generateAdvice(text) {
            const keywords = {
                '水': '飲料水の備蓄を3日分以上確保しましょう',
                '懐中電灯': '予備電池も忘れずに準備してください',
                '薬': '常用薬は常に1週間分を用意しておきましょう'
            };
            
            return Object.keys(keywords).find(k => text.includes(k)) 
                ? keywords[Object.keys(keywords).find(k => text.includes(k))]
                : '定期的な防災訓練の実施をお勧めします';
        }

        function saveToLocalStorage(key, data) {
            const items = JSON.parse(localStorage.getItem(key) || '[]');
            items.push(data);
            localStorage.setItem(key, JSON.stringify(items));
        }

        function loadFromLocalStorage() {
            const messages = JSON.parse(localStorage.getItem('messages') || '[]');
            messages.forEach(msg => {
                addMarker('messages', msg.latlng, msg.title, msg.content);
            });
            displayLogs();
        }

        function displayLogs() {
            const logs = JSON.parse(localStorage.getItem('logs') || '[]');
            const historyDiv = document.getElementById('log-history');
            historyDiv.innerHTML = logs.reverse().map(log => `
                <div class="log-entry">
                    <strong>${log.date}</strong><br>
                    ${log.content}<br>
                    <em>アドバイス: ${log.advice}</em>
                </div>
            `).join('');
        }

        // Initialize map after DOM loaded
        window.onload = initMap;
    </script>
</body>
</html>
