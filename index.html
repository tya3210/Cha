<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>防災情報マップ - 現在地を円形マーカーで表示</title>
    <style>
        html, body, #map {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        .leaflet-popup-content {
            font-size: 14px;
        }
        .message-form {
            margin: 0;
        }
        .message-form textarea {
            width: 100%;
            height: 60px;
            resize: none;
        }
        .message-list {
            max-height: 100px;
            overflow-y: auto;
            margin-top: 10px;
        }
        .message-item {
            border-bottom: 1px solid #ccc;
            padding: 5px 0;
        }
        .delete-pin {
            color: red;
            cursor: pointer;
            font-size: 12px;
        }
    </style>
    <!-- LeafletのCSSを読み込み -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
</head>
<body>
    <div id="map"></div>

    <!-- LeafletのJSを読み込み -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <!-- 地理院タイル読み込み -->
    <script src="https://maps.gsi.go.jp/js/leaflet-gsi.js"></script>
    <!-- Leaflet.LocateのCSSとJSを読み込み -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.css" />
    <script src="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.js"></script>
    <script>
        // 地図の初期化
        var map = L.map('map', {
            center: [35.681236, 139.767125], // 東京駅の位置
            zoom: 13
        });

        // 地理院地図の標準タイルを追加
        var stdMap = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png', {
            attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html'>地理院タイル</a>"
        }).addTo(map);

        // ハザードマップのレイヤー追加（浸水想定区域）
        var floodLayer = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/inundation/{z}/{x}/{y}.png', {
            opacity: 0.5
        });

        // レイヤーコントロールを追加
        var baseMaps = {
            "標準地図": stdMap
        };

        var overlayMaps = {
            "浸水想定区域": floodLayer
        };

        L.control.layers(baseMaps, overlayMaps).addTo(map);

        // 既存のピンを保持する変数
        var currentPin = null;

        // localStorageからピンのデータを読み込み
        loadPinFromStorage();

        // マップをクリックしたときの処理
        map.on('click', function(e) {
            // 既存のピンがある場合は削除
            if (currentPin) {
                map.removeLayer(currentPin);
            }

            // 新しいピンを設置
            currentPin = L.marker(e.latlng).addTo(map);

            // ピンにメッセージを保存するオブジェクトを追加
            currentPin.data = {
                messages: []
            };

            // ピンにポップアップを設定
            currentPin.bindPopup(createPopupContent(currentPin)).openPopup();

            // ピンの位置とデータを保存
            savePinToStorage();
        });

        // ポップアップの内容を生成
        function createPopupContent(marker) {
            var container = document.createElement('div');

            // メッセージフォーム
            var form = document.createElement('form');
            form.className = 'message-form';

            var textarea = document.createElement('textarea');
            textarea.placeholder = '伝言を入力してください';
            form.appendChild(textarea);

            var submitButton = document.createElement('input');
            submitButton.type = 'submit';
            submitButton.value = '投稿';
            form.appendChild(submitButton);

            // メッセージリスト
            var messageList = document.createElement('div');
            messageList.className = 'message-list';

            // 既存のメッセージを表示
            marker.data.messages.forEach(function(msg) {
                var messageItem = document.createElement('div');
                messageItem.className = 'message-item';
                messageItem.textContent = msg;
                messageList.appendChild(messageItem);
            });

            // フォーム送信時の処理
            form.onsubmit = function(e) {
                e.preventDefault();
                var msg = textarea.value.trim();
                if (msg) {
                    marker.data.messages.push(msg);

                    var messageItem = document.createElement('div');
                    messageItem.className = 'message-item';
                    messageItem.textContent = msg;
                    messageList.appendChild(messageItem);

                    textarea.value = '';
                    textarea.focus();

                    // メッセージを保存
                    savePinToStorage();
                }
            };

            container.appendChild(form);
            container.appendChild(messageList);

            // ピン削除ボタン
            var deleteLink = document.createElement('a');
            deleteLink.href = '#';
            deleteLink.className = 'delete-pin';
            deleteLink.textContent = 'このピンを削除';
            deleteLink.onclick = function(e) {
                e.preventDefault();
                map.removeLayer(marker);
                currentPin = null;
                removePinFromStorage();
            };
            container.appendChild(deleteLink);

            return container;
        }

        // 現在地を円形マーカーで表示
        function onLocationFound(e) {
            var radius = e.accuracy / 2;

            // 既存の現在地マーカーと精度円を削除
            if (currentLocationMarker) {
                map.removeLayer(currentLocationMarker);
            }
            if (currentLocationCircle) {
                map.removeLayer(currentLocationCircle);
            }

            // 円形マーカーを作成
            currentLocationMarker = L.circleMarker(e.latlng, {
                radius: 10,
                fillColor: '#3388ff',
                color: '#fff',
                weight: 2,
                opacity: 1,
                fillOpacity: 1
            }).addTo(map).bindPopup("現在地").openPopup();

            // 精度を示す円
            currentLocationCircle = L.circle(e.latlng, radius, {
                color: '#136AEC',
                fillColor: '#136AEC',
                fillOpacity: 0.15
            }).addTo(map);
        }

        var currentLocationMarker = null;
        var currentLocationCircle = null;

        map.on('locationfound', onLocationFound);

        // 位置情報取得失敗時の処理
        function onLocationError(e) {
            alert("位置情報を取得できませんでした。");
        }

        map.on('locationerror', onLocationError);

        // 現在地ボタンを追加
        L.control.locate({
            position: 'topleft',
            drawCircle: false,
            showCompass: true,
            locateOptions: {
                maxZoom: 16,
                watch: true,
                setView: true
            },
            strings: {
                title: "現在地を表示"
            },
            onLocationError: onLocationError,
            onLocationFound: onLocationFound
        }).addTo(map);

        // ピンのデータをlocalStorageに保存
        function savePinToStorage() {
            if (currentPin) {
                var pinData = {
                    latlng: currentPin.getLatLng(),
                    messages: currentPin.data.messages
                };
                localStorage.setItem('currentPin', JSON.stringify(pinData));
            }
        }

        // localStorageからピンのデータを読み込み
        function loadPinFromStorage() {
            var savedPin = localStorage.getItem('currentPin');
            if (savedPin) {
                var pinData = JSON.parse(savedPin);
                currentPin = L.marker(pinData.latlng).addTo(map);

                currentPin.data = {
                    messages: pinData.messages
                };

                currentPin.bindPopup(createPopupContent(currentPin));
            }
        }

        // ピンのデータをlocalStorageから削除
        function removePinFromStorage() {
            localStorage.removeItem('currentPin');
        }
    </script>
</body>
</html>
